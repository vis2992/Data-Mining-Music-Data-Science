```{r}
library(randomForest)
setwd("~/Documents/Data Mining/Final Project/")
train <- read.csv('train.csv');
test <- read.csv('test.csv');
words <- read.csv('words.csv');
users <- read.csv('users.csv')

words$X <- NULL;
rows <- is.na(words$Good.Lyrics)
words$Good.Lyrics[rows] <- words$Good.lyrics[rows];
words$Good.lyrics <- NULL;
words$OWN_ARTIST_MUSIC <- as.character(words$OWN_ARTIST_MUSIC);
words$OWN_ARTIST_MUSIC[substr(words$OWN_ARTIST_MUSIC, 2, 2) == 'o'] <- 'DK';
words$OWN_ARTIST_MUSIC[words$OWN_ARTIST_MUSIC == ""] <- 'DK';
words$OWN_ARTIST_MUSIC <- as.factor(words$OWN_ARTIST_MUSIC);
words$HEARD_OF[words$HEARD_OF == ''] <- 'Never heard of';
words$HEARD_OF[words$HEARD_OF == 'Ever heard music by'] <- 'Heard of and listened to music EVER';
words$HEARD_OF[words$HEARD_OF == 'Ever heard of'] <- 'Heard of';
words$HEARD_OF[words$HEARD_OF == 'Listened to recently'] <- 'Heard of and listened to music RECENTLY';
words$HEARD_OF <- droplevels(words$HEARD_OF);

words <- na.roughfix(words);

fixtimes <- function (x) {
  x <- as.character(x)
  x[x == 'Less than an hour'] <- '.5';
  x[x == 'More than 16 hours'] <- '18';
  x <- as.numeric(substr(x, 1, 2));
  return(x)
}
users$LIST_OWN <- fixtimes(users$LIST_OWN);
users$LIST_BACK <- fixtimes(users$LIST_BACK);

domerge <- function (data) {
  data$RowID <- 1:nrow(data);
  merged <- merge(data, words, all.x=T);
  merged <- merge(merged, users, by.x='User', by.y='RESPID', all.x=T)
  merged <- na.roughfix(merged);
  merged <- merged[order(merged$RowID),];
  merged$RowID <- NULL;
  return(merged);
}

trainfeats <- domerge(train)[,-4];
testfeats <- domerge(test);

cleaned <- list(trainfeats=trainfeats, testfeats=testfeats, ratings=train$Rating)
summary(cleaned)
save(cleaned, file = "cleaned.RData")
cleaned.training = cleaned[[1]]
cleaned.test = cleaned[[2]]
cleaned.rating = cleaned[[3]]
cleaned.data = data.frame(cleaned.training, cleaned.rating)
summary(cleaned.data)
```

Single Tree:
```{r}
library(tree)
data.tree = tree(cleaned.rating~.,cleaned.data)
summary(data.tree)
plot(data.tree)
text(data.tree, pretty = 0)
```

Random Forrest:
```{r}
set.seed(2)
train = sample(1:nrow(cleaned.data), 150000)
train.set = cleaned.data[train,]
test.set = cleaned.data[-train,]
rf = randomForest(cleaned.rating~., train.set, do.trace=T,sampsize = 20000, ntree=100)
```

Boosted Trees:
```{r}
boost = gbm(cleaned.rating~., train.set, distribution = "gaussian", n.trees = 1000, shrinkage = 0.01,interaction.depth = 4, verbose = T)
test <- predict(boost, test.set, n.trees = 1000)
mean((test-ts$ratings)^2)
```


